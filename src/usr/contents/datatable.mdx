---
title: "People"
date: "2023-10-01"
slug: "datatable"
description: ""
menu_position: 2
---

import { useState } from "react"
import { DataTb } from "../../modules/scms"
import { Link } from "gatsby"
import { MiniSchedina } from "../components/minischedina"

export default function PeoplePage() {
  const [showExilesFirst, setShowExilesFirst] = useState(true)

  const formatName = name =>
    name?.split(' ').map((part, i, arr) =>
      i < arr.length - 1 ? <>{part}<br /></> : part
    ) || "No Name"

  const groupByLocation = (locations) => {
    const grouped = {}
    locations.forEach(loc => {
      const place = loc.f_luoghi_id?.nome_localita
      if (!place) return
      const period = loc.prima_attestazione_anno && loc.ultima_attestazione_anno
        ? `${loc.prima_attestazione_anno}-${loc.ultima_attestazione_anno}`
        : loc.prima_attestazione_anno
        ? `${loc.prima_attestazione_anno}`
        : ""
      if (!grouped[place]) grouped[place] = []
      if (period) grouped[place].push(period)
    })
    return grouped
  }

  const splitLines = (arr, perLine = 4) => {
    const lines = []
    for (let i = 0; i < arr.length; i += perLine) {
      lines.push(arr.slice(i, i + perLine))
    }
    return lines
  }

  const formatLifeDates = item => {
    const birthYear = item.anno_nascita || 'ND'
    const birthPlace = item.luogo_nascita || 'ND'
    const deathYear = item.anno_morte || 'ND'
    const deathPlace = item.luogo_morte || 'ND'
    return `${birthYear} (${birthPlace}) - ${deathYear} (${deathPlace})`
  }

  // Colonna Exiles
  const ExilesColumn = (
    <div className="col-lg-6">
      <div className="card border-3 shadow-sm h-100" style={{ borderColor: '#e8d5b5', backgroundColor: 'transparent' }}>
        <div className="card-header border-0">
          <h3 className="card-title mb-0 text-dark">Exiles</h3>
        </div>
        <div className="card-body p-0">
          <DataTb
            source={{
              dTable: "f_persone",
              dQueryString: [
                "fields=id,nome_e_cognome,Pseudonimo,cognome_naturalizzato_o_coniuge,professione,note_sul_personaggio,",
                "luoghi_associati_alla_persona.id,luoghi_associati_alla_persona.f_luoghi_id.nome_localita,",
                "luoghi_associati_alla_persona.prima_attestazione_anno,luoghi_associati_alla_persona.ultima_attestazione_anno,luoghi_associati_alla_persona.spostato_in_qualita_di",
                "&filter[progetto][_eq]=fuoriuscitismo&limit=-1"
              ].join("")
            }}
            noHeader
            noDataComponent={<div className="p-3">No exiles found</div>}
            columns={[{
              name: "",
              cell: item => {
                const grouped = groupByLocation(item.luoghi_associati_alla_persona || [])

                const bubbleStyle = {
                  backgroundColor: '#f5f5f5',
                  border: '1px solid #ccc',
                  borderRadius: '999px',
                  padding: '0.2rem 0.6rem',
                  fontSize: '0.8rem',
                  color: '#333',
                  display: 'inline-block',
                  marginBottom: '0.25rem'
                }

                return (
                  <div className="d-flex border-bottom" style={{ width: '100%', height: '300px', overflow: 'hidden' }}>

                    {/* LEFT COLUMN — BIO */}
                    <div className="p-3 d-flex flex-column border-end" style={{ flex: '0 0 33.33%', height: '100%', overflowY: 'auto' }}>
                      <h4 className="mb-2" style={{ wordBreak: 'break-word' }}>
                        <Link to={`/record/?tb=f_persone&id=${item.id}`} className="text-decoration-none text-dark">
                          {formatName(item.nome_e_cognome)}
                        </Link>
                      </h4>

                      {/* Name variants in bubble style */}
                      <div className="mb-2 d-flex flex-wrap gap-1">
                        {item.Pseudonimo && (
                          <span style={bubbleStyle}>{item.Pseudonimo}</span>
                        )}
                        {item.cognome_naturalizzato_o_coniuge && (
                          <span style={bubbleStyle}>{item.cognome_naturalizzato_o_coniuge}</span>
                        )}
                      </div>

                      {/* Professione (vertical if multiple) */}
                      {item.professione && (
                        <div className="mt-2">
                          {item.professione.split(';').map((prof, i) => (
                            <div key={i} className="badge d-block mb-1" style={{ backgroundColor: '#d9c7a7' }}>
                              {prof.trim()}
                            </div>
                          ))}
                        </div>
                      )}

                      {item.note_sul_personaggio && (
                        <div className="mt-3 p-2 border rounded" style={{ fontSize: '0.85rem', backgroundColor: 'transparent', borderColor: '#ccc' }}>
                          <div className="fw-semibold mb-1">Notes:</div>
                          <div className="text-muted" dangerouslySetInnerHTML={{ __html: item.note_sul_personaggio }} />
                        </div>
                      )}
                    </div>

                    {/* RIGHT COLUMN — MINI LOCATION CARDS */}
                    <div className="p-3 d-flex flex-column" style={{ flex: '0 0 66.66%', height: '100%', overflowY: 'auto' }}>
                      {Object.keys(grouped).length > 0 ? (
                        <>
                          <h6 className="mb-2 text-muted small">Associated Locations</h6>
                          <div className="d-flex flex-wrap gap-2">
                            {Object.entries(grouped).map(([place, periods], idx) => (
                              <div key={idx} className="p-2 rounded border" style={{ minWidth: '150px', flex: '0 1 auto', borderColor: '#dee2e6' }}>
                                <div className="fw-semibold text-center mb-1">{place}</div>
                                {splitLines(periods).map((line, i) => (
                                  <div key={i} className="small text-center">
                                    {line.join('; ')}
                                  </div>
                                ))}
                              </div>
                            ))}
                          </div>
                        </>
                      ) : (
                        <div className="text-muted small mt-auto">No associated locations</div>
                      )}
                    </div>
                  </div>
                )
              }
            }]}
            paginationPerPage={5}
          />
        </div>
      </div>
    </div>
  )

  // Colonna Volumes
  const VolumesColumn = (
    <div className="col-lg-6">
      <div className="card border-3 shadow-sm h-100" style={{ borderColor: '#ebc7c7', backgroundColor: 'transparent' }}>
        <div className="card-header border-0">
          <h3 className="card-title mb-0 text-dark">Volumes</h3>
        </div>
        <div className="card-body p-0">
          <DataTb
            source={{
              dTable: "f_persone",
              dQueryString: [
                "fields=id,nome_e_cognome,cognome_naturalizzato_o_coniuge,other_attested_names,anno_nascita,luogo_nascita,anno_morte,luogo_morte,",
                "volumi_associati_alla_persona.id,volumi_associati_alla_persona.note_sul_rapporto_,",
                "volumi_associati_alla_persona.tipo_di_rapporto,",
                "volumi_associati_alla_persona.f_fonti_id.id,",
                "volumi_associati_alla_persona.f_fonti_id.titolo_breve",
                "&filter[progetto][_eq]=volumi&limit=-1"
              ].join("")
            }}
            noHeader
            noDataComponent={<div className="p-3">No figures found</div>}
            columns={[{
              name: "",
              cell: item => (
                <div className="d-flex border-bottom" style={{ width: '100%', height: '300px', overflow: 'hidden' }}>
                  <div className="p-3 d-flex flex-column border-end" style={{ flex: '0 0 33.33%', height: '100%', overflowY: 'auto' }}>
                    <h4 className="mb-1" style={{ wordBreak: 'break-word' }}>
                      {formatName(item.nome_e_cognome)}
                    </h4>

                    <div className="d-flex flex-wrap gap-1 mb-2">
                      {[item.cognome_naturalizzato_o_coniuge, ...(item.other_attested_names ? item.other_attested_names.split(',') : [])]
                        .filter(Boolean)
                        .map((name, idx) => (
                          <span
                            key={idx}
                            className="badge rounded-pill"
                            style={{
                              backgroundColor: '#f5f5f5',
                              border: '1px solid #ccc',
                              color: '#333',
                              fontSize: '0.75rem',
                              padding: '0.35em 0.6em',
                            }}
                          >
                            {name.trim()}
                          </span>
                        ))}
                    </div>

                    <div className="mb-2 small text-muted">{formatLifeDates(item)}</div>
                  </div>

                  <div className="p-3 d-flex flex-column" style={{ flex: '0 0 66.66%', height: '100%', overflowY: 'auto' }}>
                    <MiniSchedina items={item.volumi_associati_alla_persona} type="volume" />
                  </div>
                </div>
              )
            }]}
            paginationPerPage={5}
          />
        </div>
      </div>
    </div>
  )

  return (
    <div className="container-fluid mt-4">
      {/* Bottoni switch (solo su mobile) */}
      <div className="d-flex justify-content-center mb-3 d-lg-none">
        <button
          onClick={() => setShowExilesFirst(true)}
          className="btn rounded-3 me-2 p-3"
          style={{
            width: '120px',
            fontSize: '1.1rem',
            fontWeight: '500',
            backgroundColor: '#f5f0e6',
            color: '#5a3e3e',
            border: showExilesFirst ? '3px solid #d4a5a5' : '2px solid #d4a5a5',
            boxShadow: showExilesFirst ? '6px 6px 0 rgba(0,0,0,0.1)' : '4px 4px 0 rgba(0,0,0,0.1)',
            transition: 'all 0.3s ease',
          }}
        >
          Exiles
        </button>
        <button
          onClick={() => setShowExilesFirst(false)}
          className="btn rounded-3 p-3"
          style={{
            width: '120px',
            fontSize: '1.1rem',
            fontWeight: '500',
            backgroundColor: '#f9ecec',
            color: '#5a3e3e',
            border: !showExilesFirst ? '3px solid #d4a5a5' : '2px solid #d4a5a5',
            boxShadow: !showExilesFirst ? '6px 6px 0 rgba(0,0,0,0.1)' : '4px 4px 0 rgba(0,0,0,0.1)',
            transition: 'all 0.3s ease',
          }}
        >
          Volumes
        </button>
      </div>

      {/* Colonne in ordine dinamico */}
      <div className="row g-4">
        {showExilesFirst ? (
          <>
            {ExilesColumn}
            {VolumesColumn}
          </>
        ) : (
          <>
            {VolumesColumn}
            {ExilesColumn}
          </>
        )}
      </div>
    </div>
  )
}
